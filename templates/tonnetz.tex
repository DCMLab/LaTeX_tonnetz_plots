% declare layers and specify ordering
\pgfdeclarelayer{bbg}       % behind background
\pgfdeclarelayer{bg}        % background
\pgfdeclarelayer{main}      % main layer
\pgfdeclarelayer{fg}        % foreground
\pgfdeclarelayer{bfg}       % before foreground
\pgfsetlayers{bbg,bg,main,fg,bfg}
  
% adjust size (TODO: replace by units in fifths (x) and thirds (y))
\def\minx{-2}
\def\maxx{5}
\def\miny{-2}
\def\maxy{4}


%%%% BEHIND BACKGROUND (-2) %%%%

% TODO: add chord/key labels at hexagon junctions
% draw hexagons (comment out for not plotting)
\def\withhex{}
\newcommand*{\hex}[1]{
  \def\r{0.55}
  \begin{pgfonlayer}{bbg}
    \draw[black!6,fill=black!4] ($(#1)+(30:\r)$) -- ($(#1)+(90:\r)$) -- ($(#1)+(150:\r)$)  -- ($(#1)+(210:\r)$) -- ($(#1)+(270:\r)$) -- ($(#1)+(330:\r)$) -- cycle;
  \end{pgfonlayer}
}
\newcommand*{\xy}[2]{
  \pgfmathsetmacro{\x}{#1+cos(60)*#2}
  \pgfmathsetmacro{\y}{sin(60)*#2}
}
\newcommand*{\xycoord}[2]{($#1*(1,0)+#2*(60:1)$)}
\newcommand*{\xycoordcenterbelow}[2]{(${#1+0.333}*(1,0)+{#2+0.333-1}*(60:1)$)}
\newcommand*{\xycoordcenterabove}[2]{(${#1-0.333}*(1,0)+{#2+0.666}*(60:1)$)}

\tikzstyle{tone}=[circle, draw, fill=white, minimum size=2.5em]

\begin{tikzpicture}[scale=2]

  %%%% MAIN LAYER (0) %%%%

  % TODO: base grid and coordinates on fifths/thirds locations
  % create the basic grid on main layer
  \begin{pgfonlayer}{main}
    \foreach \x in {-10,...,10} {
      \foreach \y in {-10,...,10} {
        \pgfmathsetmacro{\xx}{\x+cos(60)*mod(\y+100,2)}
        \pgfmathsetmacro{\yy}{sin(60)*\y}
        \ifthenelse{\x>\minx\AND\x<\maxx\AND\y>\miny\AND\y<\maxy}{
          \ifdefined\withhex\hex{\xx,\yy}\fi
          \coordinate (n_\x_\y) at (\xx,\yy);
          \pgfmathsetmacro{\xMOne}{int(\x-1)}
          \pgfmathsetmacro{\yMOne}{int(\y-1)}
          \pgfmathsetmacro{\yPOne}{int(\y+1)}
          \pgfmathsetmacro{\xxMOne}{\xMOne+cos(60)*mod(\yMOne+100,2)}
          \pgfmathsetmacro{\yyMOne}{sin(60)*\yMOne}
          \pgfmathsetmacro{\yyPOne}{sin(60)*\yPOne}
          \pgfmathsetmacro{\iseven}{int(mod(\y+100,2))}
          \ifthenelse{\xMOne>\minx\AND\xMOne<\maxx}{
            \draw (n_\x_\y) -- (n_\xMOne_\y);
          }{}
          \ifthenelse{\yMOne>\miny\AND\yMOne<\maxy}{
            \draw (n_\x_\y) -- (n_\x_\yMOne);
          }{}
          \ifthenelse{\xMOne>\minx\AND\xMOne<\maxx\AND\yMOne>\miny\AND\yMOne<\maxy}{
            \ifthenelse{\iseven=0}{
              \draw (n_\x_\y) -- (n_\xMOne_\yMOne);
            }{}
          }{}
          \ifthenelse{\xMOne>\minx\AND\xMOne<\maxx\AND\yPOne>\miny\AND\yPOne<\maxy}{
            \ifthenelse{\iseven=0}{
              \draw (n_\x_\y) -- (n_\xMOne_\yPOne);
            }{}
          }{}
        }{}
      }
    }
  \end{pgfonlayer}

  %%%% BACKGROUND (-1) %%%%

  % coloured areas on background
  \begin{pgfonlayer}{bg}
    \draw[fill=BrickRed, opacity=0.3] \xycoord{0}{0} -- \xycoord{2}{0} -- \xycoord{2}{1} -- \xycoord{0}{1} -- cycle;
  \end{pgfonlayer}

  %%%% FOREGROUND (+1) %%%%
  
  %%%% BEFORE FOREGROUND (+2) %%%%

  % draw some arrows on foreground
  \begin{pgfonlayer}{fg}
    \draw[->, >=stealth, shorten >= 1.5em, shorten <= 1.5em, line width=3pt, BurntOrange] \xycoord{0}{0} -- \xycoord{1}{1};
    \draw[->, >=stealth, line width=3pt, RoyalBlue] \xycoordcenterbelow{1}{1} -- \xycoordcenterabove{3}{0};
    \draw[->, >=stealth, line width=3pt, BrickRed] \xycoord{0.5}{1.5} -- \xycoord{1.5}{1.5};
    \draw[->, >=stealth, line width=3pt, OliveGreen] \xycoord{-0.75}{2.5} -- \xycoord{1.25}{2.5};
  \end{pgfonlayer}

  % TODO: put labels on fifths/third locations
  % create tone names on topmost layer
  \begin{pgfonlayer}{bfg}
    \foreach \nodename/\name/\fifths/\thirds in {
      A+/{A$\sharp$}/-2/3, E+/{E$\sharp$}/-1/3, B+/{B$\sharp$}/0/3, F++/{F$\sharp\sharp$}/1/3, C++/{C$\sharp\sharp$}/2/3, G++/{G$\sharp\sharp$}/3/3,
      F+/{F$\sharp$}/-2/2, C+/{C$\sharp$}/-1/2, G+/{G$\sharp$}/0/2, D+/{D$\sharp$}/1/2, A+/{A$\sharp$}/2/2, E+/{E$\sharp$}/3/2,
      A/A/-1/1, E/E/0/1, B/B/1/1, F+/{F$\sharp$}/2/1, C+/{C$\sharp$}/3/1, G+/{G$\sharp$}/4/1,
      F/F/-1/0, C/C/0/0, G/G/1/0, D/D/2/0, A/A/3/0, E/E/4/0,
      A-/{A$\flat$}/0/-1, E-/{E$\flat$}/1/-1, B-/{B$\flat$}/2/-1, F/F/3/-1, C/C/4/-1, G/G/5/-1
    } {
      \node[tone] (\nodename) at \xycoord{\fifths}{\thirds} {\name};
    }
  \end{pgfonlayer}

\end{tikzpicture}